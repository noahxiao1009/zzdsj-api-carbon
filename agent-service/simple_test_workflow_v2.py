#!/usr/bin/env python3
"""
ç®€åŒ–çš„Workflow v2æµ‹è¯•è„šæœ¬
åªæµ‹è¯•æ ¸å¿ƒä»£ç ç”ŸæˆåŠŸèƒ½ï¼Œä¸ä¾èµ–å¤–éƒ¨æ¨¡å—
"""
import sys
import os
from typing import Dict, List, Any
from dataclasses import dataclass, field

# æ¨¡æ‹Ÿæ•°æ®ç»“æ„
@dataclass
class AgentComponent:
    id: str
    name: str
    description: str
    model_name: str
    instructions: str
    tools: List[str] = field(default_factory=list)
    temperature: float = 0.7
    max_tokens: int = 1000

@dataclass
class WorkflowStep:
    id: str
    name: str
    type: str
    component_ref: str
    config: Dict[str, Any] = field(default_factory=dict)
    dependencies: List[str] = field(default_factory=list)

@dataclass
class WorkflowComponents:
    agents: List[AgentComponent] = field(default_factory=list)
    models: List[Any] = field(default_factory=list)
    tools: List[Any] = field(default_factory=list)
    knowledge_bases: List[str] = field(default_factory=list)

@dataclass
class WorkflowLogic:
    steps: List[WorkflowStep] = field(default_factory=list)
    conditions: List[Any] = field(default_factory=list)
    variables: Dict[str, Any] = field(default_factory=dict)

@dataclass
class WorkflowV2Config:
    id: str
    name: str
    description: str
    components: WorkflowComponents
    logic: WorkflowLogic
    metadata: Dict[str, Any] = field(default_factory=dict)


class WorkflowCodeGenerator:
    """ç®€åŒ–ç‰ˆä»£ç ç”Ÿæˆå™¨ - åªåŒ…å«æ ¸å¿ƒåŠŸèƒ½"""
    
    def __init__(self):
        self.template_base = """
from typing import Iterator, Any, Dict
from agno.workflow import Workflow, RunResponse, RunEvent
from agno.agent import Agent
from agno.models.openai import OpenAIChat
from agno.models.anthropic import Claude
from agno.tools import ReasoningTools, SearchTools, CalculatorTools, FileTools
from agno.storage.sqlite import SqliteStorage


class {workflow_class_name}(Workflow):
    \"\"\"
    {workflow_description}
    
    Generated by ZZDSJ Carbon Agent Service
    \"\"\"
    
    description: str = \"{workflow_description}\"
    
    # ç»„ä»¶å®šä¹‰
{component_definitions}
    
    def run(self, {input_parameters}) -> Iterator[RunResponse]:
        \"\"\"æ‰§è¡Œå·¥ä½œæµä¸»é€»è¾‘\"\"\"
{run_method_body}
        """
    
    def generate_workflow_code(self, config: WorkflowV2Config) -> str:
        """ç”Ÿæˆå®Œæ•´çš„Workflow Pythonä»£ç """
        try:
            # ç”Ÿæˆç±»å
            class_name = self._generate_class_name(config.name)
            
            # ç”Ÿæˆç»„ä»¶å®šä¹‰
            component_definitions = self._generate_component_definitions(config.components)
            
            # ç”Ÿæˆrunæ–¹æ³•å‚æ•°
            input_parameters = self._generate_input_parameters(config.logic)
            
            # ç”Ÿæˆrunæ–¹æ³•ä½“
            run_method_body = self._generate_run_method(config.logic, config.components)
            
            # åº”ç”¨æ¨¡æ¿
            code = self.template_base.format(
                workflow_class_name=class_name,
                workflow_description=config.description,
                component_definitions=component_definitions,
                input_parameters=input_parameters,
                run_method_body=run_method_body
            )
            
            return self._format_code(code)
            
        except Exception as e:
            raise ValueError(f"Failed to generate workflow code: {str(e)}")
    
    def _generate_class_name(self, workflow_name: str) -> str:
        """ç”Ÿæˆç¬¦åˆPythonè§„èŒƒçš„ç±»å"""
        import re
        clean_name = re.sub(r'[^a-zA-Z0-9\u4e00-\u9fff]', ' ', workflow_name)
        words = clean_name.split()
        class_name = ''.join(word.capitalize() for word in words if word)
        return f"{class_name}Workflow" if class_name else "CustomWorkflow"
    
    def _generate_component_definitions(self, components: WorkflowComponents) -> str:
        """ç”Ÿæˆç»„ä»¶å®šä¹‰ä»£ç """
        definitions = []
        
        # ç”ŸæˆAgentå®šä¹‰
        for agent in components.agents:
            model_class = self._get_model_class(agent.model_name)
            tools = self._format_tools(agent.tools)
            
            agent_def = f"""    {agent.id} = Agent(
        name="{agent.name}",
        model={model_class},
        tools=[{tools}],
        instructions=\"\"\"{agent.instructions}\"\"\",
        temperature={agent.temperature},
        max_tokens={agent.max_tokens}
    )"""
            definitions.append(agent_def)
        
        return '\n\n'.join(definitions) if definitions else "    # No components defined"
    
    def _get_model_class(self, model_name: str) -> str:
        """æ ¹æ®æ¨¡å‹åç§°ç”Ÿæˆæ¨¡å‹ç±»å®ä¾‹åŒ–ä»£ç """
        model_mapping = {
            'gpt-4': 'OpenAIChat(id="gpt-4")',
            'gpt-4o': 'OpenAIChat(id="gpt-4o")',
            'gpt-4o-mini': 'OpenAIChat(id="gpt-4o-mini")',
            'claude-3-5-sonnet': 'Claude(id="claude-3-5-sonnet-20241022")',
            'claude-3-haiku': 'Claude(id="claude-3-haiku-20240307")',
        }
        return model_mapping.get(model_name, f'OpenAIChat(id="{model_name}")')
    
    def _format_tools(self, tools: List[str]) -> str:
        """æ ¼å¼åŒ–å·¥å…·åˆ—è¡¨"""
        tool_mapping = {
            'reasoning': 'ReasoningTools()',
            'search': 'SearchTools()',
            'calculator': 'CalculatorTools()',
            'file': 'FileTools()',
            'web_search': 'WebSearchTools()'
        }
        
        formatted_tools = []
        for tool in tools:
            if tool in tool_mapping:
                formatted_tools.append(tool_mapping[tool])
            else:
                formatted_tools.append(f'# Unknown tool: {tool}')
        
        return ', '.join(formatted_tools)
    
    def _generate_input_parameters(self, logic: WorkflowLogic) -> str:
        """ç”Ÿæˆè¾“å…¥å‚æ•°"""
        input_vars = logic.variables.get('inputs', ['message'])
        if isinstance(input_vars, str):
            input_vars = [input_vars]
        
        params = []
        for var in input_vars:
            if var == 'message':
                params.append('message: str')
            else:
                params.append(f'{var}: Any')
        
        return ', '.join(params) if params else 'input_data: Any'
    
    def _generate_run_method(self, logic: WorkflowLogic, components: WorkflowComponents) -> str:
        """ç”Ÿæˆrunæ–¹æ³•ä½“"""
        if not logic.steps:
            return """        # ç®€å•å›æ˜¾ç¤ºä¾‹
        yield RunResponse(
            content=f"å¤„ç†å®Œæˆ: {message}",
            event=RunEvent.workflow_completed
        )"""
        
        method_body = []
        method_body.append("        logger.info(f\"å¼€å§‹æ‰§è¡Œå·¥ä½œæµ\")")
        method_body.append("")
        
        # ç”Ÿæˆæ­¥éª¤æ‰§è¡Œé€»è¾‘
        for step in logic.steps:
            step_code = self._generate_step_code(step, components)
            method_body.append(step_code)
            method_body.append("")
        
        # æ·»åŠ æœ€ç»ˆç»“æœè¿”å›
        method_body.append("        yield RunResponse(")
        method_body.append("            content=final_result,")
        method_body.append("            event=RunEvent.workflow_completed")
        method_body.append("        )")
        
        return '\n'.join(method_body)
    
    def _generate_step_code(self, step: WorkflowStep, components: WorkflowComponents) -> str:
        """ç”Ÿæˆå•ä¸ªæ­¥éª¤çš„ä»£ç """
        if step.type == 'agent_run':
            return f"""        # æ‰§è¡Œæ­¥éª¤: {step.name}
        {step.id}_result = yield from self.{step.component_ref}.run(message, stream=True)
        final_result = {step.id}_result.content"""
        
        elif step.type == 'condition_check':
            return f"""        # æ¡ä»¶æ£€æŸ¥: {step.name}
        if {step.config.get('condition', 'True')}:
            # æ¡ä»¶ä¸ºçœŸçš„å¤„ç†é€»è¾‘
            pass
        else:
            # æ¡ä»¶ä¸ºå‡çš„å¤„ç†é€»è¾‘
            pass"""
        
        else:
            return f"""        # æ­¥éª¤: {step.name} (ç±»å‹: {step.type})
        # TODO: å®ç°å…·ä½“é€»è¾‘
        pass"""
    
    def _format_code(self, code: str) -> str:
        """æ ¼å¼åŒ–ç”Ÿæˆçš„ä»£ç """
        try:
            import ast
            ast.parse(code)
            return code.strip()
        except SyntaxError as e:
            print(f"è­¦å‘Š: ç”Ÿæˆçš„ä»£ç å­˜åœ¨è¯­æ³•é”™è¯¯: {e}")
            return code.strip()
    
    def validate_generated_code(self, code: str) -> Dict[str, Any]:
        """éªŒè¯ç”Ÿæˆçš„ä»£ç """
        validation_result = {
            'syntax_valid': False,
            'agno_compliant': False,
            'warnings': [],
            'errors': []
        }
        
        try:
            import ast
            tree = ast.parse(code)
            validation_result['syntax_valid'] = True
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«Workflowç±»
            has_workflow_class = False
            for node in ast.walk(tree):
                if isinstance(node, ast.ClassDef):
                    for base in node.bases:
                        if isinstance(base, ast.Name) and base.id == 'Workflow':
                            has_workflow_class = True
                            break
            
            validation_result['agno_compliant'] = has_workflow_class
            
            if not has_workflow_class:
                validation_result['warnings'].append('ä»£ç ä¸­æœªæ‰¾åˆ°ç»§æ‰¿è‡ªWorkflowçš„ç±»')
                
        except SyntaxError as e:
            validation_result['errors'].append(f'è¯­æ³•é”™è¯¯: {str(e)}')
        except Exception as e:
            validation_result['errors'].append(f'éªŒè¯è¿‡ç¨‹é”™è¯¯: {str(e)}')
        
        return validation_result


def create_test_config() -> WorkflowV2Config:
    """åˆ›å»ºæµ‹è¯•é…ç½®"""
    agent = AgentComponent(
        id="customer_service_agent",
        name="å®¢æœåŠ©æ‰‹",
        description="æ™ºèƒ½å®¢æœåŠ©æ‰‹",
        model_name="gpt-4o",
        instructions="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹ï¼Œè¯·ç¤¼è²Œåœ°å›ç­”ç”¨æˆ·é—®é¢˜ã€‚",
        tools=["reasoning", "search"],
        temperature=0.7,
        max_tokens=1000
    )
    
    step = WorkflowStep(
        id="service_step",
        name="å®¢æœå¤„ç†",
        type="agent_run",
        component_ref="customer_service_agent",
        config={},
        dependencies=[]
    )
    
    components = WorkflowComponents(agents=[agent])
    logic = WorkflowLogic(
        steps=[step],
        variables={"inputs": ["message"]}
    )
    
    return WorkflowV2Config(
        id="customer_service_workflow",
        name="å®¢æœå·¥ä½œæµ",
        description="æ™ºèƒ½å®¢æœå¤„ç†å·¥ä½œæµï¼ŒåŸºäºGPT-4oæ¨¡å‹æä¾›ä¸“ä¸šçš„å®¢æœæ”¯æŒ",
        components=components,
        logic=logic
    )


def test_code_generation():
    """æµ‹è¯•ä»£ç ç”ŸæˆåŠŸèƒ½"""
    print("ğŸ”§ æµ‹è¯•Agno Workflow v2ä»£ç ç”Ÿæˆå™¨")
    print("=" * 60)
    
    # åˆ›å»ºä»£ç ç”Ÿæˆå™¨
    generator = WorkflowCodeGenerator()
    
    # æµ‹è¯•ç±»åç”Ÿæˆ
    print("1. æµ‹è¯•ç±»åç”Ÿæˆ:")
    test_names = ["å®¢æœåŠ©æ‰‹", "Customer Service", "simple-test", ""]
    for name in test_names:
        class_name = generator._generate_class_name(name)
        print(f"   '{name}' -> '{class_name}'")
    
    print()
    
    # æµ‹è¯•å·¥å…·æ ¼å¼åŒ–
    print("2. æµ‹è¯•å·¥å…·æ ¼å¼åŒ–:")
    tools = ['reasoning', 'search', 'calculator', 'unknown_tool']
    formatted = generator._format_tools(tools)
    print(f"   {tools} -> {formatted}")
    
    print()
    
    # æµ‹è¯•æ¨¡å‹ç±»æ˜ å°„
    print("3. æµ‹è¯•æ¨¡å‹ç±»æ˜ å°„:")
    models = ['gpt-4', 'gpt-4o', 'claude-3-5-sonnet', 'custom-model']
    for model in models:
        model_class = generator._get_model_class(model)
        print(f"   '{model}' -> '{model_class}'")
    
    print()
    
    # æµ‹è¯•å®Œæ•´ä»£ç ç”Ÿæˆ
    print("4. æµ‹è¯•å®Œæ•´ä»£ç ç”Ÿæˆ:")
    config = create_test_config()
    
    try:
        code = generator.generate_workflow_code(config)
        print("   âœ… ä»£ç ç”ŸæˆæˆåŠŸ")
        
        # éªŒè¯ä»£ç 
        validation = generator.validate_generated_code(code)
        print(f"   âœ… è¯­æ³•æ£€æŸ¥: {'é€šè¿‡' if validation['syntax_valid'] else 'å¤±è´¥'}")
        print(f"   âœ… Agnoå…¼å®¹æ€§: {'é€šè¿‡' if validation['agno_compliant'] else 'å¤±è´¥'}")
        
        if validation['errors']:
            print(f"   âŒ é”™è¯¯: {validation['errors']}")
        if validation['warnings']:
            print(f"   âš ï¸  è­¦å‘Š: {validation['warnings']}")
        
        print("\n5. ç”Ÿæˆçš„Pythonä»£ç :")
        print("-" * 60)
        print(code)
        print("-" * 60)
        
    except Exception as e:
        print(f"   âŒ ä»£ç ç”Ÿæˆå¤±è´¥: {e}")
    
    print("\nğŸ‰ æµ‹è¯•å®Œæˆ!")


def test_multiple_agents():
    """æµ‹è¯•å¤šæ™ºèƒ½ä½“å·¥ä½œæµ"""
    print("\nğŸ”§ æµ‹è¯•å¤šæ™ºèƒ½ä½“å·¥ä½œæµç”Ÿæˆ")
    print("=" * 60)
    
    generator = WorkflowCodeGenerator()
    
    # åˆ›å»ºå¤šæ™ºèƒ½ä½“é…ç½®
    agents = [
        AgentComponent(
            id="intent_agent",
            name="æ„å›¾è¯†åˆ«åŠ©æ‰‹",
            description="è¯†åˆ«ç”¨æˆ·æ„å›¾",
            model_name="claude-3-haiku",
            instructions="åˆ†æç”¨æˆ·æ¶ˆæ¯ï¼Œè¯†åˆ«æ„å›¾å’Œæƒ…æ„Ÿ",
            tools=["reasoning"],
            temperature=0.3
        ),
        AgentComponent(
            id="response_agent",
            name="å›å¤ç”ŸæˆåŠ©æ‰‹",
            description="ç”Ÿæˆä¸“ä¸šå›å¤",
            model_name="gpt-4o",
            instructions="æ ¹æ®æ„å›¾åˆ†æç»“æœï¼Œç”Ÿæˆä¸“ä¸šå‹å¥½çš„å›å¤",
            tools=["reasoning", "search"],
            temperature=0.7
        )
    ]
    
    steps = [
        WorkflowStep(
            id="intent_step",
            name="æ„å›¾è¯†åˆ«",
            type="agent_run",
            component_ref="intent_agent"
        ),
        WorkflowStep(
            id="response_step",
            name="ç”Ÿæˆå›å¤",
            type="agent_run",
            component_ref="response_agent",
            dependencies=["intent_step"]
        )
    ]
    
    components = WorkflowComponents(agents=agents)
    logic = WorkflowLogic(steps=steps, variables={"inputs": ["message"]})
    
    config = WorkflowV2Config(
        id="multi_agent_workflow",
        name="å¤šæ™ºèƒ½ä½“å®¢æœå·¥ä½œæµ",
        description="åŸºäºæ„å›¾è¯†åˆ«å’Œå›å¤ç”Ÿæˆçš„å¤šæ™ºèƒ½ä½“åä½œå·¥ä½œæµ",
        components=components,
        logic=logic
    )
    
    try:
        code = generator.generate_workflow_code(config)
        validation = generator.validate_generated_code(code)
        
        print("   âœ… å¤šæ™ºèƒ½ä½“ä»£ç ç”ŸæˆæˆåŠŸ")
        print(f"   âœ… è¯­æ³•æ£€æŸ¥: {'é€šè¿‡' if validation['syntax_valid'] else 'å¤±è´¥'}")
        print(f"   âœ… Agnoå…¼å®¹æ€§: {'é€šè¿‡' if validation['agno_compliant'] else 'å¤±è´¥'}")
        
        print("\nç”Ÿæˆçš„å¤šæ™ºèƒ½ä½“å·¥ä½œæµä»£ç :")
        print("-" * 60)
        print(code)
        print("-" * 60)
        
    except Exception as e:
        print(f"   âŒ å¤šæ™ºèƒ½ä½“ä»£ç ç”Ÿæˆå¤±è´¥: {e}")


if __name__ == "__main__":
    # è¿è¡ŒåŸºç¡€æµ‹è¯•
    test_code_generation()
    
    # è¿è¡Œå¤šæ™ºèƒ½ä½“æµ‹è¯•
    test_multiple_agents()
    
    print("\nğŸŠ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼Agno Workflow v2ç®¡ç†å™¨æ ¸å¿ƒåŠŸèƒ½éªŒè¯æˆåŠŸï¼") 