#!/usr/bin/env python3
"""
ç¡…åŸºæµåŠ¨é›†æˆæµ‹è¯•è„šæœ¬
æµ‹è¯•ä¿®æ”¹åçš„workflow_v2_managerä½¿ç”¨ç¡…åŸºæµåŠ¨APIçš„åŠŸèƒ½
"""
import sys
import os
from typing import Dict, List, Any
from dataclasses import dataclass, field

# æ¨¡æ‹Ÿæ•°æ®ç»“æ„
@dataclass
class AgentComponent:
    id: str
    name: str
    description: str
    model_name: str
    instructions: str
    tools: List[str] = field(default_factory=list)
    temperature: float = 0.7
    max_tokens: int = 1000

@dataclass
class WorkflowStep:
    id: str
    name: str
    type: str
    component_ref: str
    config: Dict[str, Any] = field(default_factory=dict)
    dependencies: List[str] = field(default_factory=list)

@dataclass
class WorkflowComponents:
    agents: List[AgentComponent] = field(default_factory=list)
    models: List[Any] = field(default_factory=list)
    tools: List[Any] = field(default_factory=list)
    knowledge_bases: List[str] = field(default_factory=list)

@dataclass
class WorkflowLogic:
    steps: List[WorkflowStep] = field(default_factory=list)
    conditions: List[Any] = field(default_factory=list)
    variables: Dict[str, Any] = field(default_factory=dict)

@dataclass
class WorkflowV2Config:
    id: str
    name: str
    description: str
    components: WorkflowComponents
    logic: WorkflowLogic
    metadata: Dict[str, Any] = field(default_factory=dict)


class SiliconFlowWorkflowCodeGenerator:
    """ç¡…åŸºæµåŠ¨å·¥ä½œæµä»£ç ç”Ÿæˆå™¨ - ç®€åŒ–ç‰ˆæœ¬"""
    
    def __init__(self):
        self.template_base = """
import asyncio
from typing import Iterator, Any, Dict, AsyncGenerator
import logging

logger = logging.getLogger(__name__)


class SiliconFlowModel:
    \"\"\"ç¡…åŸºæµåŠ¨æ¨¡å‹åŒ…è£…ç±»\"\"\"
    def __init__(self, model_id: str):
        self.model_id = model_id


class SiliconFlowAgent:
    \"\"\"ç¡…åŸºæµåŠ¨æ™ºèƒ½ä½“æ¨¡æ‹Ÿç±»\"\"\"
    def __init__(self, name: str, model_name: str, instructions: str, tools: List[str], temperature: float, max_tokens: int):
        self.name = name
        self.model_name = model_name
        self.instructions = instructions
        self.tools = tools
        self.temperature = temperature
        self.max_tokens = max_tokens
    
    async def run(self, message: str) -> Dict[str, Any]:
        \"\"\"æ¨¡æ‹Ÿè¿è¡Œæ™ºèƒ½ä½“\"\"\"
        logger.info(f"æ¨¡æ‹Ÿæ‰§è¡Œæ™ºèƒ½ä½“ {{self.name}} å¤„ç†æ¶ˆæ¯: {{message}}")
        # æ¨¡æ‹ŸAPIè°ƒç”¨å»¶è¿Ÿ
        await asyncio.sleep(0.1)
        
        response_content = f"[{{self.name}}] åŸºäº{{self.model_name}}æ¨¡å‹å¤„ç†: {{message}}"
        return {{
            "content": response_content,
            "model": self.model_name,
            "usage": {{"total_tokens": 100}}
        }}


class SiliconFlowAdapter:
    \"\"\"ç¡…åŸºæµåŠ¨é€‚é…å™¨æ¨¡æ‹Ÿç±»\"\"\"
    async def create_agent_instance(self, agent_config: Dict[str, Any]) -> SiliconFlowAgent:
        return SiliconFlowAgent(
            name=agent_config['name'],
            model_name=agent_config['model_name'], 
            instructions=agent_config['instructions'],
            tools=agent_config['tools'],
            temperature=agent_config['temperature'],
            max_tokens=agent_config['max_tokens']
        )

# å…¨å±€é€‚é…å™¨å®ä¾‹
siliconflow_adapter = SiliconFlowAdapter()


class {workflow_class_name}:
    \"\"\"
    {workflow_description}
    
    Generated by ZZDSJ Carbon Agent Service
    Based on SiliconFlow API
    \"\"\"
    
    description: str = \"{workflow_description}\"
    
    # ç»„ä»¶å®šä¹‰
{component_definitions}
    
    async def run(self, {input_parameters}) -> Dict[str, Any]:
        \"\"\"æ‰§è¡Œå·¥ä½œæµä¸»é€»è¾‘\"\"\"
{run_method_body}
        """
    
    def generate_workflow_code(self, config: WorkflowV2Config) -> str:
        """ç”Ÿæˆå®Œæ•´çš„Workflow Pythonä»£ç """
        try:
            # ç”Ÿæˆç±»å
            class_name = self._generate_class_name(config.name)
            
            # ç”Ÿæˆç»„ä»¶å®šä¹‰
            component_definitions = self._generate_component_definitions(config.components)
            
            # ç”Ÿæˆrunæ–¹æ³•å‚æ•°
            input_parameters = self._generate_input_parameters(config.logic)
            
            # ç”Ÿæˆrunæ–¹æ³•ä½“
            run_method_body = self._generate_run_method(config.logic, config.components)
            
            # åº”ç”¨æ¨¡æ¿
            code = self.template_base.format(
                workflow_class_name=class_name,
                workflow_description=config.description,
                component_definitions=component_definitions,
                input_parameters=input_parameters,
                run_method_body=run_method_body
            )
            
            return self._format_code(code)
            
        except Exception as e:
            raise ValueError(f"Failed to generate workflow code: {str(e)}")
    
    def _generate_class_name(self, workflow_name: str) -> str:
        """ç”Ÿæˆç¬¦åˆPythonè§„èŒƒçš„ç±»å"""
        import re
        clean_name = re.sub(r'[^a-zA-Z0-9\u4e00-\u9fff]', ' ', workflow_name)
        words = clean_name.split()
        class_name = ''.join(word.capitalize() for word in words if word)
        return f"{class_name}Workflow" if class_name else "CustomWorkflow"
    
    def _generate_component_definitions(self, components: WorkflowComponents) -> str:
        """ç”Ÿæˆç»„ä»¶å®šä¹‰ä»£ç """
        definitions = []
        
        # ç”ŸæˆAgentå®šä¹‰
        for agent in components.agents:
            siliconflow_model_id = self._get_siliconflow_model_id(agent.model_name)
            
            agent_def = f"""    async def create_{agent.id}(self):
        \"\"\"åˆ›å»º{agent.name}\"\"\"
        agent_config = {{
            'name': "{agent.name}",
            'model_name': "{siliconflow_model_id}",
            'instructions': \"\"\"{agent.instructions}\"\"\",
            'tools': {agent.tools},
            'temperature': {agent.temperature},
            'max_tokens': {agent.max_tokens}
        }}
        return await siliconflow_adapter.create_agent_instance(agent_config)"""
            definitions.append(agent_def)
        
        return '\n\n'.join(definitions) if definitions else "    # No components defined"
    
    def _get_siliconflow_model_id(self, model_name: str) -> str:
        """è·å–ç¡…åŸºæµåŠ¨æ¨¡å‹ID"""
        # æ¨¡å‹æ˜ å°„
        model_mapping = {
            'gpt-4': 'Qwen/Qwen3-32B',
            'gpt-4o': 'Qwen/Qwen3-32B', 
            'gpt-4o-mini': 'Qwen/Qwen3-32B',
            'claude-3-5-sonnet': 'moonshotai/Kimi-K2-Instruct',
            'claude-3-haiku': 'Qwen/Qwen3-32B',
        }
        return model_mapping.get(model_name, 'Qwen/Qwen3-32B')
    
    def _generate_input_parameters(self, logic: WorkflowLogic) -> str:
        """ç”Ÿæˆè¾“å…¥å‚æ•°"""
        input_vars = logic.variables.get('inputs', ['message'])
        if isinstance(input_vars, str):
            input_vars = [input_vars]
        
        params = []
        for var in input_vars:
            if var == 'message':
                params.append('message: str')
            else:
                params.append(f'{var}: Any')
        
        return ', '.join(params) if params else 'input_data: Any'
    
    def _generate_run_method(self, logic: WorkflowLogic, components: WorkflowComponents) -> str:
        """ç”Ÿæˆrunæ–¹æ³•ä½“"""
        if not logic.steps:
            return """        # ç®€å•å›æ˜¾ç¤ºä¾‹
        logger.info(f"æ‰§è¡Œå·¥ä½œæµ: {message}")
        return {
            "status": "completed",
            "result": f"å¤„ç†å®Œæˆ: {message}",
            "message": message
        }"""
        
        method_body = []
        method_body.append("        logger.info(f\"å¼€å§‹æ‰§è¡Œå·¥ä½œæµ: {message}\")")
        method_body.append("        results = {}")
        method_body.append("")
        
        # ç”Ÿæˆæ­¥éª¤æ‰§è¡Œé€»è¾‘
        for step in logic.steps:
            step_code = self._generate_step_code(step, components)
            method_body.append(step_code)
            method_body.append("")
        
        # æ·»åŠ æœ€ç»ˆç»“æœè¿”å›
        method_body.append("        return {")
        method_body.append("            \"status\": \"completed\",")
        method_body.append("            \"result\": final_result,")
        method_body.append("            \"steps_results\": results,")
        method_body.append("            \"message\": message")
        method_body.append("        }")
        
        return '\n'.join(method_body)
    
    def _generate_step_code(self, step: WorkflowStep, components: WorkflowComponents) -> str:
        """ç”Ÿæˆå•ä¸ªæ­¥éª¤çš„ä»£ç """
        if step.type == 'agent_run':
            return f"""        # æ‰§è¡Œæ­¥éª¤: {step.name}
        logger.info(f"æ‰§è¡Œæ™ºèƒ½ä½“: {step.name}")
        {step.component_ref}_instance = await self.create_{step.component_ref}()
        {step.id}_result = await {step.component_ref}_instance.run(message)
        results["{step.id}"] = {step.id}_result
        final_result = {step.id}_result.get("content", str({step.id}_result))"""
        else:
            return f"""        # æ­¥éª¤: {step.name} (ç±»å‹: {step.type})
        logger.info(f"æ‰§è¡Œæ­¥éª¤: {step.name}")
        step_result = f"æ­¥éª¤{step.name}æ‰§è¡Œå®Œæˆ"
        results["{step.id}"] = step_result
        final_result = step_result"""
    
    def _format_code(self, code: str) -> str:
        """æ ¼å¼åŒ–ç”Ÿæˆçš„ä»£ç """
        try:
            import ast
            ast.parse(code)
            return code.strip()
        except SyntaxError as e:
            print(f"è­¦å‘Š: ç”Ÿæˆçš„ä»£ç å­˜åœ¨è¯­æ³•é”™è¯¯: {e}")
            return code.strip()
    
    def validate_generated_code(self, code: str) -> Dict[str, Any]:
        """éªŒè¯ç”Ÿæˆçš„ä»£ç """
        validation_result = {
            'syntax_valid': False,
            'siliconflow_compliant': False,
            'warnings': [],
            'errors': []
        }
        
        try:
            import ast
            tree = ast.parse(code)
            validation_result['syntax_valid'] = True
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å·¥ä½œæµç±»å’Œrunæ–¹æ³•
            has_workflow_class = False
            has_run_method = False
            
            for node in ast.walk(tree):
                if isinstance(node, ast.ClassDef):
                    if 'Workflow' in node.name:
                        has_workflow_class = True
                        # æ£€æŸ¥æ˜¯å¦æœ‰runæ–¹æ³•
                        for item in node.body:
                            if isinstance(item, ast.AsyncFunctionDef) and item.name == 'run':
                                has_run_method = True
                                break
            
            validation_result['siliconflow_compliant'] = has_workflow_class and has_run_method
            
            if not has_workflow_class:
                validation_result['warnings'].append('ä»£ç ä¸­æœªæ‰¾åˆ°å·¥ä½œæµç±»')
            if not has_run_method:
                validation_result['warnings'].append('ä»£ç ä¸­æœªæ‰¾åˆ°å¼‚æ­¥runæ–¹æ³•')
                
            # æ£€æŸ¥æ˜¯å¦åŒ…å«ç¡…åŸºæµåŠ¨ç›¸å…³å¯¼å…¥
            has_siliconflow_import = 'siliconflow_adapter' in code
            if not has_siliconflow_import:
                validation_result['warnings'].append('ä»£ç ä¸­æœªæ‰¾åˆ°ç¡…åŸºæµåŠ¨é€‚é…å™¨å¯¼å…¥')
                
        except SyntaxError as e:
            validation_result['errors'].append(f'è¯­æ³•é”™è¯¯: {str(e)}')
        except Exception as e:
            validation_result['errors'].append(f'éªŒè¯è¿‡ç¨‹é”™è¯¯: {str(e)}')
        
        return validation_result


def create_test_configs() -> List[WorkflowV2Config]:
    """åˆ›å»ºæµ‹è¯•é…ç½®"""
    configs = []
    
    # 1. ç®€å•å®¢æœå·¥ä½œæµ
    agent1 = AgentComponent(
        id="customer_service_agent",
        name="å®¢æœåŠ©æ‰‹",
        description="æ™ºèƒ½å®¢æœåŠ©æ‰‹",
        model_name="gpt-4o",
        instructions="ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å®¢æœåŠ©æ‰‹ï¼Œä½¿ç”¨ç¡…åŸºæµåŠ¨Qwen3-32Bæ¨¡å‹æä¾›æœåŠ¡ã€‚è¯·ç¤¼è²Œåœ°å›ç­”ç”¨æˆ·é—®é¢˜ã€‚",
        tools=["reasoning", "search"],
        temperature=0.7,
        max_tokens=1000
    )
    
    step1 = WorkflowStep(
        id="service_step",
        name="å®¢æœå¤„ç†",
        type="agent_run",
        component_ref="customer_service_agent",
        config={},
        dependencies=[]
    )
    
    config1 = WorkflowV2Config(
        id="siliconflow_customer_service",
        name="ç¡…åŸºæµåŠ¨å®¢æœå·¥ä½œæµ",
        description="åŸºäºç¡…åŸºæµåŠ¨APIçš„æ™ºèƒ½å®¢æœå¤„ç†å·¥ä½œæµ",
        components=WorkflowComponents(agents=[agent1]),
        logic=WorkflowLogic(steps=[step1], variables={"inputs": ["message"]})
    )
    configs.append(config1)
    
    # 2. å¤šæ™ºèƒ½ä½“åä½œå·¥ä½œæµ
    agent2 = AgentComponent(
        id="intent_agent",
        name="æ„å›¾è¯†åˆ«åŠ©æ‰‹",
        description="è¯†åˆ«ç”¨æˆ·æ„å›¾",
        model_name="claude-3-haiku",
        instructions="ä½¿ç”¨ç¡…åŸºæµåŠ¨Qwen3-32Bæ¨¡å‹åˆ†æç”¨æˆ·æ¶ˆæ¯ï¼Œè¯†åˆ«æ„å›¾å’Œæƒ…æ„Ÿ",
        tools=["reasoning"],
        temperature=0.3,
        max_tokens=500
    )
    
    agent3 = AgentComponent(
        id="response_agent", 
        name="å›å¤ç”ŸæˆåŠ©æ‰‹",
        description="ç”Ÿæˆä¸“ä¸šå›å¤",
        model_name="claude-3-5-sonnet",
        instructions="ä½¿ç”¨ç¡…åŸºæµåŠ¨Kimi-K2-Instructæ¨¡å‹æ ¹æ®æ„å›¾åˆ†æç»“æœï¼Œç”Ÿæˆä¸“ä¸šå‹å¥½çš„å›å¤",
        tools=["reasoning", "search"],
        temperature=0.7,
        max_tokens=1000
    )
    
    step2 = WorkflowStep(
        id="intent_step",
        name="æ„å›¾è¯†åˆ«",
        type="agent_run",
        component_ref="intent_agent"
    )
    
    step3 = WorkflowStep(
        id="response_step",
        name="ç”Ÿæˆå›å¤",
        type="agent_run",
        component_ref="response_agent",
        dependencies=["intent_step"]
    )
    
    config2 = WorkflowV2Config(
        id="siliconflow_multi_agent",
        name="ç¡…åŸºæµåŠ¨å¤šæ™ºèƒ½ä½“å·¥ä½œæµ",
        description="åŸºäºç¡…åŸºæµåŠ¨APIçš„å¤šæ™ºèƒ½ä½“åä½œå·¥ä½œæµï¼ŒåŒ…å«æ„å›¾è¯†åˆ«å’Œå›å¤ç”Ÿæˆ",
        components=WorkflowComponents(agents=[agent2, agent3]),
        logic=WorkflowLogic(steps=[step2, step3], variables={"inputs": ["message"]})
    )
    configs.append(config2)
    
    return configs


async def test_generated_workflow():
    """æµ‹è¯•ç”Ÿæˆçš„å·¥ä½œæµæ‰§è¡Œ"""
    print("\nğŸš€ æµ‹è¯•ç¡…åŸºæµåŠ¨å·¥ä½œæµæ‰§è¡Œ")
    print("=" * 60)
    
    generator = SiliconFlowWorkflowCodeGenerator()
    configs = create_test_configs()
    
    for i, config in enumerate(configs, 1):
        print(f"\n{i}. æµ‹è¯•å·¥ä½œæµ: {config.name}")
        print("-" * 40)
        
        try:
            # ç”Ÿæˆä»£ç 
            code = generator.generate_workflow_code(config)
            
            # éªŒè¯ä»£ç 
            validation = generator.validate_generated_code(code)
            print(f"   âœ… è¯­æ³•æ£€æŸ¥: {'é€šè¿‡' if validation['syntax_valid'] else 'å¤±è´¥'}")
            print(f"   âœ… ç¡…åŸºæµåŠ¨å…¼å®¹æ€§: {'é€šè¿‡' if validation['siliconflow_compliant'] else 'å¤±è´¥'}")
            
            if validation['warnings']:
                for warning in validation['warnings']:
                    print(f"   âš ï¸  è­¦å‘Š: {warning}")
            
            if validation['errors']:
                for error in validation['errors']:
                    print(f"   âŒ é”™è¯¯: {error}")
                continue
            
            # å°è¯•æ‰§è¡Œç”Ÿæˆçš„ä»£ç 
            print("   ğŸ”„ å°è¯•æ‰§è¡Œå·¥ä½œæµ...")
            
            # åŠ¨æ€æ‰§è¡Œä»£ç 
            local_scope = {}
            exec(code, local_scope)
            
            # æŸ¥æ‰¾å·¥ä½œæµç±»
            workflow_class = None
            for name, obj in local_scope.items():
                if name.endswith('Workflow') and hasattr(obj, 'run'):
                    workflow_class = obj
                    break
            
            if workflow_class:
                # åˆ›å»ºå®ä¾‹å¹¶æ‰§è¡Œ
                workflow_instance = workflow_class()
                result = await workflow_instance.run("ä½ å¥½ï¼Œæˆ‘éœ€è¦å¸®åŠ©")
                
                print(f"   âœ… æ‰§è¡ŒæˆåŠŸ!")
                print(f"   ğŸ“ ç»“æœçŠ¶æ€: {result.get('status', 'unknown')}")
                print(f"   ğŸ’¬ å›å¤å†…å®¹: {result.get('result', 'No result')[:100]}...")
                
                if result.get('steps_results'):
                    print(f"   ğŸ“Š æ­¥éª¤æ•°é‡: {len(result['steps_results'])}")
            else:
                print("   âŒ æœªæ‰¾åˆ°å·¥ä½œæµç±»")
                
        except Exception as e:
            print(f"   âŒ æµ‹è¯•å¤±è´¥: {e}")


def test_siliconflow_integration():
    """æµ‹è¯•ç¡…åŸºæµåŠ¨é›†æˆ"""
    print("ğŸ”§ æµ‹è¯•ç¡…åŸºæµåŠ¨é›†æˆ - Workflow v2ä»£ç ç”Ÿæˆå™¨")
    print("=" * 60)
    
    # åˆ›å»ºä»£ç ç”Ÿæˆå™¨
    generator = SiliconFlowWorkflowCodeGenerator()
    
    # åˆ›å»ºæµ‹è¯•é…ç½®
    configs = create_test_configs()
    
    for i, config in enumerate(configs, 1):
        print(f"\n{i}. ç”Ÿæˆå·¥ä½œæµ: {config.name}")
        print("-" * 40)
        
        try:
            # ç”Ÿæˆä»£ç 
            code = generator.generate_workflow_code(config)
            
            # éªŒè¯ä»£ç 
            validation = generator.validate_generated_code(code)
            
            print(f"   âœ… ä»£ç ç”ŸæˆæˆåŠŸ")
            print(f"   âœ… è¯­æ³•æ£€æŸ¥: {'é€šè¿‡' if validation['syntax_valid'] else 'å¤±è´¥'}")
            print(f"   âœ… ç¡…åŸºæµåŠ¨å…¼å®¹æ€§: {'é€šè¿‡' if validation['siliconflow_compliant'] else 'å¤±è´¥'}")
            
            if validation['warnings']:
                for warning in validation['warnings']:
                    print(f"   âš ï¸  è­¦å‘Š: {warning}")
            
            if validation['errors']:
                for error in validation['errors']:
                    print(f"   âŒ é”™è¯¯: {error}")
            
            # æ˜¾ç¤ºç”Ÿæˆçš„ä»£ç ç‰‡æ®µ
            lines = code.split('\n')
            print("\n   ğŸ“„ ç”Ÿæˆçš„ä»£ç ç‰‡æ®µ (å‰20è¡Œ):")
            for j, line in enumerate(lines[:20], 1):
                print(f"   {j:2d}: {line}")
            if len(lines) > 20:
                print(f"   ... çœç•¥{len(lines) - 20}è¡Œ")
            
        except Exception as e:
            print(f"   âŒ ä»£ç ç”Ÿæˆå¤±è´¥: {e}")


def test_model_mapping():
    """æµ‹è¯•æ¨¡å‹æ˜ å°„"""
    print("\nğŸ”„ æµ‹è¯•ç¡…åŸºæµåŠ¨æ¨¡å‹æ˜ å°„")
    print("=" * 60)
    
    generator = SiliconFlowWorkflowCodeGenerator()
    
    test_models = [
        'gpt-4', 'gpt-4o', 'gpt-4o-mini',
        'claude-3-5-sonnet', 'claude-3-haiku',
        'custom-model'
    ]
    
    for model in test_models:
        mapped_model = generator._get_siliconflow_model_id(model)
        print(f"   {model:20s} -> {mapped_model}")


if __name__ == "__main__":
    import asyncio
    
    # è¿è¡ŒåŸºç¡€æµ‹è¯•
    test_siliconflow_integration()
    
    # è¿è¡Œæ¨¡å‹æ˜ å°„æµ‹è¯•
    test_model_mapping()
    
    # è¿è¡Œæ‰§è¡Œæµ‹è¯•
    asyncio.run(test_generated_workflow())
    
    print("\nğŸŠ ç¡…åŸºæµåŠ¨é›†æˆæµ‹è¯•å®Œæˆï¼")
    print("âœ¨ Workflow v2ç®¡ç†å™¨å·²æˆåŠŸé€‚é…ç¡…åŸºæµåŠ¨API")
    print("ğŸ”— æ”¯æŒçš„ç¡…åŸºæµåŠ¨æ¨¡å‹:")
    print("   - Qwen/Qwen3-32B (èŠå¤©)")
    print("   - moonshotai/Kimi-K2-Instruct (èŠå¤©)")
    print("   - Qwen/Qwen3-235B-A22B (èŠå¤©)")
    print("   - Qwen/Qwen3-Embedding-8B (åµŒå…¥)")
    print("   - Qwen/Qwen3-Reranker-8B (é‡æ’åº)") 