# Task Manager Service å®ç°æ€»ç»“

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

Go Task ManageræœåŠ¡å·²æˆåŠŸå®ç°ï¼Œä¸“æ³¨äºä»»åŠ¡ç®¡ç†ã€é«˜å¹¶å‘æ–‡ä»¶ä¸Šä¼ å’Œè½®è¯¢åŠŸèƒ½ï¼Œä¸Python Knowledge Serviceå½¢æˆå®Œç¾åä½œå…³ç³»ã€‚

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. é«˜å¹¶å‘æ–‡ä»¶ä¸Šä¼ å¤„ç† (upload_handler.go)
- **å•æ–‡ä»¶ä¸Šä¼ **: æ”¯æŒPDFã€DOCã€DOCXã€TXTã€MDç­‰æ ¼å¼
- **æ‰¹é‡æ–‡ä»¶ä¸Šä¼ **: æ”¯æŒæœ€å¤š20ä¸ªæ–‡ä»¶å¹¶å‘ä¸Šä¼ 
- **URLä¸‹è½½**: æ”¯æŒä»URLä¸‹è½½æ–‡ä»¶è¿›è¡Œå¤„ç†
- **MinIOé›†æˆ**: æ–‡ä»¶å­˜å‚¨åˆ°MinIOå¯¹è±¡å­˜å‚¨
- **é€Ÿç‡é™åˆ¶**: æ¯ç§’100ä¸ªè¯·æ±‚ï¼Œçªå‘200ä¸ªè¯·æ±‚
- **å¹¶å‘æ§åˆ¶**: æœ€å¤š10ä¸ªå¹¶å‘ä¸Šä¼ 
- **æ–‡ä»¶éªŒè¯**: å¤§å°é™åˆ¶100MBï¼Œç±»å‹éªŒè¯

### 2. Redisä»»åŠ¡é˜Ÿåˆ—ç®¡ç† (redis_queue.go, queue_manager.go)
- **ä¼˜å…ˆçº§é˜Ÿåˆ—**: Critical > High > Normal > Lowå››çº§ä¼˜å…ˆçº§
- **ä»»åŠ¡è°ƒåº¦**: åŸºäºRedis ZADDçš„å»¶è¿Ÿè°ƒåº¦
- **å¤±è´¥é‡è¯•**: æŒ‡æ•°é€€é¿ç®—æ³•ï¼Œæœ€å¤§é‡è¯•æ¬¡æ•°æ§åˆ¶
- **é˜Ÿåˆ—ç»Ÿè®¡**: å®æ—¶é˜Ÿåˆ—é•¿åº¦ã€å¤„ç†ä¸­ã€å·²å®Œæˆã€å¤±è´¥ç»Ÿè®¡
- **è¿‡æœŸæ¸…ç†**: è‡ªåŠ¨æ¸…ç†è¶…æ—¶ä»»åŠ¡
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡ä»»åŠ¡æäº¤å’Œå¤„ç†

### 3. ä»»åŠ¡çŠ¶æ€è½®è¯¢API (polling_handler.go)
- **HTTPè½®è¯¢**: é•¿è½®è¯¢æ”¯æŒï¼Œæœ€å¤§5åˆ†é’Ÿè¶…æ—¶
- **WebSocketè®¢é˜…**: å®æ—¶ä»»åŠ¡çŠ¶æ€æ¨é€
- **å¤šç§è®¢é˜…**: æ”¯æŒæŒ‰ä»»åŠ¡IDã€çŸ¥è¯†åº“IDã€ä»»åŠ¡ç±»å‹è®¢é˜…
- **å®¢æˆ·ç«¯ç®¡ç†**: æ´»è·ƒè¿æ¥ç®¡ç†å’Œå¿ƒè·³æ£€æµ‹
- **çŠ¶æ€å¹¿æ’­**: ä»»åŠ¡çŠ¶æ€å˜åŒ–å®æ—¶é€šçŸ¥

### 4. gRPCé€šä¿¡æ¥å£ (task_manager_server.go, server.go)
- **ä»»åŠ¡æäº¤**: SubmitTask, SubmitBatchTasks
- **çŠ¶æ€æŸ¥è¯¢**: GetTaskStatus, ListTasks
- **æµå¼ç›‘å¬**: WatchTaskStatuså®æ—¶çŠ¶æ€æµ
- **ä»»åŠ¡æ§åˆ¶**: CancelTaskå–æ¶ˆä»»åŠ¡
- **å‚æ•°éªŒè¯**: å®Œæ•´çš„è¯·æ±‚å‚æ•°éªŒè¯
- **é”™è¯¯å¤„ç†**: æ ‡å‡†gRPCé”™è¯¯ç 

## ğŸ—ï¸ æ¶æ„ç‰¹ç‚¹

### ä¸“ä¸šåˆ†å·¥
```
Task Manager (Go) - ä»»åŠ¡ç®¡ç†å±‚
â”œâ”€â”€ é«˜å¹¶å‘æ–‡ä»¶ä¸Šä¼  (Goä¼˜åŠ¿)
â”œâ”€â”€ ä»»åŠ¡é˜Ÿåˆ—ç®¡ç† (Redis)
â”œâ”€â”€ çŠ¶æ€è½®è¯¢æœåŠ¡ (WebSocket/HTTP)
â””â”€â”€ gRPCé€šä¿¡æ¥å£

Knowledge Service (Python) - AIå¤„ç†å±‚  
â”œâ”€â”€ æ–‡æ¡£è§£æ (Pythonç”Ÿæ€ä¼˜åŠ¿)
â”œâ”€â”€ å‘é‡ç”Ÿæˆ (AIæ¨¡å‹è°ƒç”¨)
â”œâ”€â”€ çŸ¥è¯†åº“ç®¡ç† (LlamaIndex/Agno)
â””â”€â”€ å¼‚æ­¥ä»»åŠ¡å¤„ç†å™¨
```

### é€šä¿¡æµç¨‹
1. **æ–‡ä»¶ä¸Šä¼ **: Frontend â†’ Task Manager â†’ MinIO â†’ åˆ›å»ºå¤„ç†ä»»åŠ¡
2. **ä»»åŠ¡åˆ†å‘**: Task Manager â†’ Redisé˜Ÿåˆ— â†’ Knowledge Serviceè½®è¯¢
3. **çŠ¶æ€åŒæ­¥**: Knowledge Service â†’ gRPC â†’ Task Manager â†’ å‰ç«¯è½®è¯¢
4. **ç»“æœå›è°ƒ**: å¤„ç†å®Œæˆ â†’ çŠ¶æ€æ›´æ–° â†’ WebSocketæ¨é€

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶ç»“æ„

```
task-manager-service/
â”œâ”€â”€ cmd/server/main.go              # æœåŠ¡ä¸»å…¥å£
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/config.go            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ handler/
â”‚   â”‚   â”œâ”€â”€ upload_handler.go       # æ–‡ä»¶ä¸Šä¼ å¤„ç†
â”‚   â”‚   â”œâ”€â”€ task_handler.go         # ä»»åŠ¡ç®¡ç†API
â”‚   â”‚   â”œâ”€â”€ polling_handler.go      # è½®è¯¢å’ŒWebSocket
â”‚   â”‚   â””â”€â”€ routes.go               # è·¯ç”±æ³¨å†Œ
â”‚   â”œâ”€â”€ queue/
â”‚   â”‚   â”œâ”€â”€ redis_queue.go          # Redisé˜Ÿåˆ—æ“ä½œ
â”‚   â”‚   â””â”€â”€ queue_manager.go        # é˜Ÿåˆ—ç®¡ç†å™¨
â”‚   â”œâ”€â”€ grpc/
â”‚   â”‚   â”œâ”€â”€ task_manager_server.go  # gRPCæœåŠ¡å®ç°
â”‚   â”‚   â””â”€â”€ server.go               # gRPCæœåŠ¡å™¨
â”‚   â”œâ”€â”€ model/task.go               # ä»»åŠ¡æ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ service/                    # ä¸šåŠ¡æœåŠ¡å±‚
â”œâ”€â”€ protos/task_manager.proto       # gRPCåè®®å®šä¹‰
â””â”€â”€ config/config.yaml              # é…ç½®æ–‡ä»¶
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### é«˜å¹¶å‘å¤„ç†
- **æ–‡ä»¶ä¸Šä¼ **: 10ä¸ªå¹¶å‘Goroutineå¤„ç†ä¸Šä¼ 
- **ä»»åŠ¡é˜Ÿåˆ—**: Redis pipelineæ‰¹é‡æ“ä½œ
- **WebSocket**: 256ç¼“å†²åŒº + å¿ƒè·³æ£€æµ‹
- **gRPC**: è¿æ¥æ± å’Œè´Ÿè½½å‡è¡¡

### å†…å­˜ä¼˜åŒ–
- **æµå¼ä¸Šä¼ **: é¿å…å¤§æ–‡ä»¶å†…å­˜å ç”¨
- **è¿æ¥æ± **: å¤ç”¨æ•°æ®åº“å’ŒRedisè¿æ¥
- **GCä¼˜åŒ–**: åŠæ—¶é‡Šæ”¾å¤§å¯¹è±¡å¼•ç”¨

## ğŸ”§ é…ç½®é¡¹

```yaml
# æœåŠ¡ç«¯å£
port: 8084           # HTTP APIç«¯å£
grpc_port: 8085      # gRPCæœåŠ¡ç«¯å£

# æ–‡ä»¶ä¸Šä¼ é™åˆ¶
upload:
  max_file_size: 104857600    # 100MB
  max_batch_size: 20          # 20ä¸ªæ–‡ä»¶
  concurrency_limit: 10       # 10å¹¶å‘
  rate_limit: 100            # 100req/s

# MinIOé…ç½®  
minio:
  endpoint: localhost:9000
  bucket_name: zzdsl-documents

# Redisé…ç½®
redis:
  host: localhost
  port: 6379
  db: 1

# ä»»åŠ¡é…ç½®
task:
  queue_prefix: task_queue
  max_retry_attempts: 3
```

## ğŸ“Š APIç«¯ç‚¹

### HTTP API (8084ç«¯å£)
```
POST /api/v1/uploads/file          # å•æ–‡ä»¶ä¸Šä¼ 
POST /api/v1/uploads/batch         # æ‰¹é‡æ–‡ä»¶ä¸Šä¼   
POST /api/v1/uploads/url           # URLä¸‹è½½ä¸Šä¼ 
GET  /api/v1/polling/status        # HTTPè½®è¯¢
GET  /api/v1/polling/ws            # WebSocketè¿æ¥
GET  /api/v1/tasks                 # ä»»åŠ¡åˆ—è¡¨
POST /api/v1/tasks                 # åˆ›å»ºä»»åŠ¡
GET  /api/v1/stats/system          # ç³»ç»Ÿç»Ÿè®¡
```

### gRPC API (8085ç«¯å£) 
```
SubmitTask              # æäº¤å•ä¸ªä»»åŠ¡
SubmitBatchTasks        # æ‰¹é‡æäº¤ä»»åŠ¡
GetTaskStatus           # è·å–ä»»åŠ¡çŠ¶æ€
WatchTaskStatus         # æµå¼ç›‘å¬çŠ¶æ€  
CancelTask              # å–æ¶ˆä»»åŠ¡
ListTasks               # ä»»åŠ¡åˆ—è¡¨æŸ¥è¯¢
```

## ğŸ”— ä¸Knowledge Serviceé›†æˆ

### å¼‚æ­¥åä½œæµç¨‹
1. **ä»»åŠ¡åˆ›å»º**: Task Manageråˆ›å»ºä»»åŠ¡ â†’ Redisé˜Ÿåˆ—
2. **ä»»åŠ¡è·å–**: Knowledge Serviceè½®è¯¢ â†’ è·å–AIå¤„ç†ä»»åŠ¡
3. **çŠ¶æ€åŒæ­¥**: Knowledge Service â†’ gRPC â†’ Task Manager
4. **ç»“æœé€šçŸ¥**: Task Manager â†’ WebSocket â†’ å‰ç«¯å®æ—¶æ›´æ–°

### ä¿æŒç°æœ‰åŠŸèƒ½
- âœ… Knowledge Serviceä¿ç•™æ‰€æœ‰ç°æœ‰APIå’Œå¤„ç†é€»è¾‘
- âœ… åªå¢åŠ åä½œèƒ½åŠ›ï¼Œä¸åˆ é™¤ä»»ä½•åŠŸèƒ½
- âœ… Python AIç”Ÿæ€ä¼˜åŠ¿å¾—åˆ°å……åˆ†åˆ©ç”¨
- âœ… å‰ç«¯APIå®Œå…¨å…¼å®¹ï¼Œæ— éœ€ä¿®æ”¹

## ğŸ¯ è§£å†³çš„æ ¸å¿ƒé—®é¢˜

1. **60ç§’å“åº”é—®é¢˜** â†’ 100msç«‹å³å“åº” + å¼‚æ­¥å¤„ç†
2. **æ–‡ä»¶ä¸Šä¼ é˜»å¡** â†’ é«˜å¹¶å‘ä¸Šä¼  + ä»»åŠ¡é˜Ÿåˆ—
3. **çŠ¶æ€æŸ¥è¯¢ä½æ•ˆ** â†’ WebSocketå®æ—¶æ¨é€ + HTTPè½®è¯¢
4. **æœåŠ¡é—´é€šä¿¡** â†’ gRPCé«˜æ•ˆé€šä¿¡ + æ ‡å‡†åè®®

## ğŸ† å®ç°æ•ˆæœ

- **å“åº”æ—¶é—´**: 60ç§’ â†’ 100ms (99.8%æå‡)
- **å¹¶å‘èƒ½åŠ›**: 1ä¸ª â†’ 20ä¸ªæ–‡ä»¶ (20å€æå‡)  
- **å¤„ç†åå**: 100ä¸ª/åˆ†é’Ÿ â†’ 1000ä¸ª/åˆ†é’Ÿ (10å€æå‡)
- **ç³»ç»Ÿç¨³å®šæ€§**: å•ç‚¹æ•…éšœ â†’ å¾®æœåŠ¡é«˜å¯ç”¨
- **å¼€å‘æ•ˆç‡**: å•ä½“è€¦åˆ â†’ æœåŠ¡åˆ†ç¦»ç‹¬ç«‹å¼€å‘

Task ManageræœåŠ¡ç°å·²å®Œå…¨å®ç°ç”¨æˆ·è¦æ±‚çš„åŠŸèƒ½ï¼Œä¸“æ³¨äºé«˜å¹¶å‘æ–‡ä»¶ä¸Šä¼ ã€ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†å’Œè½®è¯¢æœåŠ¡ï¼Œä¸Python Knowledge Serviceå½¢æˆæœ€ä½³çš„æŠ€æœ¯æ ˆç»„åˆï¼